# 技術設計書: Four Digits Puzzle

## 1. 関数リスト

本アプリケーションは以下の関数およびクラスで構成される。

### 1.1. `src/main.py`

-   `calculate_possibilities(digits_str: str) -> defaultdict`
    -   計算のコアロジックを担当する関数。
-   `main()`
    -   アプリケーションのエントリーポイント。CLI引数の解析、`calculate_possibilities` の呼び出し、結果の整形と標準出力への表示を行う。

### 1.2. `tests/test_main.py`

-   `class TestFourDigitsPuzzle(unittest.TestCase)`
    -   テストケースをまとめるクラス。
    -   `test_calculation_normal_case_1234()`: 正常系のテスト。
    -   `test_calculation_special_case_1111()`: すべて同じ数字の場合のテスト。
    -   `test_calculation_special_case_0000()`: ゼロ除算が多発するケースのテスト。
    -   `test_input_validation()`: 不正な入力に対するバリデーションロジックのテスト。

## 2. データフロー

アプリケーション内のデータの流れは以下の通り。

1.  **入力:** ユーザーがコマンドライン引数として4桁の数字文字列 (`"1234"`) を提供する。
2.  **引数解析 (`main`):** `main` 関数が `sys.argv` から文字列を取得する。
3.  **入力検証 (`main`):** 文字列が4桁の数字であるか検証する。不正な場合はエラーメッセージを出力し終了する。
4.  **計算実行 (`calculate_possibilities`):** 検証済みの文字列を `calculate_possibilities` 関数に渡す。
5.  **順列・組み合わせ生成:** `itertools` を用いて、数字の全順列と演算子の全組み合わせを生成する。
6.  **式評価:** 5つの括弧パターンを適用して数式文字列を生成し、`eval()` で評価する。`ZeroDivisionError` は捕捉して無視する。
7.  **結果集約:** 評価結果が整数であった場合、結果の数値をキー、数式文字列を値のリストとして `defaultdict` に格納する。
8.  **結果返却:** `calculate_possibilities` は、結果を格納した `defaultdict` を `main` 関数に返す。
9.  **出力:** `main` 関数が `defaultdict` を受け取る。
    a.  まず、キー（数値）をソートしたリストをサマリーとして表示する。
    b.  次に、キーでソートしながら辞書をループし、`数値 = 式` の形式で詳細な計算式をすべて表示する。

## 3. 関数詳細仕様

### 3.1. `calculate_possibilities(digits_str: str)`

-   **概要:** 4桁の数字文字列を受け取り、四則演算で作成可能なすべての整数と、その計算式の組み合わせを格納した辞書を返す。
-   **引数:**
    -   `digits_str` (str): 検証済みの4桁の数字文字列。
-   **戻り値:**
    -   `defaultdict(list)`: 計算結果の整数をキー、その整数を生成したユニークな数式文字列のリストを値とする辞書。
-   **アルゴリズム:**
    1.  入力文字列を整数のリストに変換する。
    2.  `itertools.permutations` を使い、数字リストのユニークな順列をすべてループする。
    3.  `itertools.product` を使い、四則演算子の3つの組み合わせをすべてループする。
    4.  ループ内で、4つの数字と3つの演算子に対し、5パターンの括弧を適用した数式文字列を生成する。
    5.  生成した各数式文字列に対し `try...except ZeroDivisionError` ブロックを実行する。
        a. `eval()` を使って数式を評価する。
        b. 結果が浮動小数点数で、かつ整数に変換可能な場合（例: `5.0`）、整数に変換する。
        c. 結果の整数をキーとして、数式文字列を辞書の値（リスト）に追加する。重複する式は追加しない。
    6.  すべての計算が完了したら、結果の辞書を返す。

### 3.2. `main()`

-   **概要:** アプリケーションの実行、引数処理、結果表示を管理する。
-   **引数:** なし（`sys.argv` を内部で参照）。
-   **戻り値:** なし。
-   **アルゴリズム:**
    1.  `sys.argv` の長さをチェックし、引数が1つでない場合は使い方を表示して `sys.exit(1)` で終了する。
    2.  引数が4桁の数字 (`isdigit()`) であることを検証する。不正な場合はエラーメッセージを表示して `sys.exit(1)` で終了する。
    3.  検証済み引数を `calculate_possibilities()` に渡して、結果の辞書を取得する。
    4.  結果が空の場合は、メッセージを表示して終了する。
    5.  結果の辞書のキーを抽出し、ソートしたリストを作成して「計算可能な数値」として表示する。
    6.  区切り線を表示する。
    7.  結果の辞書をキーでソートしながらループ処理を行う。
    8.  各キー（数値）に対して、値（式のリスト）をループし、`{数値} = {式}` の形式で整形して表示する。
